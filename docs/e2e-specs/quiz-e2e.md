# クイズ・進捗ページ E2Eテスト仕様書

生成日: 2026-01-12
対象ページ: `/quiz`
権限レベル: ゲスト（認証なし）

---

## テスト環境

```yaml
URL: http://localhost:3847/quiz
認証: なし（MVPフェーズ）
バックエンドAPI: http://localhost:8534
テストデータ: 実データ（Prisma Seed）
```

---

## 統合テストでカバー済み（E2Eから除外）

以下の項目はバックエンド統合テストで既にカバーされているため、E2Eテストには含めません。

### クイズ機能（backend/tests/integration/quiz/quiz.flow.test.ts）
- ✅ GET /api/quizzes: ランダムクイズ取得の正常系
- ✅ GET /api/quizzes/story/:storyId: ストーリー別クイズ取得の正常系
- ✅ POST /api/quizzes/answer: 回答送信＋フィードバック取得の正常系
- ✅ 404エラー: 存在しないストーリーID
- ✅ 404エラー: 存在しないクイズID
- ✅ 400バリデーション: 必須フィールド不足
- ✅ 400バリデーション: 無効なresponse_method
- ✅ 400バリデーション: 無効な選択肢ID
- ✅ クイズデータ構造の検証（quiz_id, question_text, choices等）
- ✅ 選択肢データ構造の検証（choice_id, choice_text, is_correct）
- ✅ 正解時のフィードバック（is_correct: true, explanation）
- ✅ 不正解時のフィードバック（is_correct: false, explanation, sample_answer）

### 進捗管理機能（backend/tests/integration/progress/progress.flow.test.ts）
- ✅ GET /api/progress: 学習進捗データ取得の正常系
- ✅ GET /api/progress/graph: 進捗グラフデータ取得の正常系
- ✅ 400バリデーション: 無効なperiodパラメータ
- ✅ 進捗データ構造の検証（total_quizzes, correct_count, accuracy_rate等）
- ✅ レベル別進捗データの検証（N5/N4/N3/N2/N1）
- ✅ グラフデータポイント構造の検証（date, accuracy_rate, level）
- ✅ 正答率の計算ロジック検証
- ✅ 期間別グラフデータ取得（week/month/year）
- ✅ クイズ回答後の進捗更新フロー

---

## E2Eテスト項目一覧（UIフローのみ: 8項目）

| ID | テスト項目 | 期待結果 |
|----|----------|---------|
| E2E-QUIZ-001 | ページアクセス・初期表示 | `/quiz`にアクセス → ページタイトル「理解度チェック」表示 → クイズカード表示 |
| E2E-QUIZ-002 | ランダムクイズ表示フロー | 「ランダムクイズ」ボタンクリック → 問題文表示 → 3つの選択肢表示 → レベル表示 |
| E2E-QUIZ-003 | 正解回答フロー（テキスト） | クイズ表示 → 正しい選択肢クリック → 「送信」ボタン → 正解フィードバック表示（緑色） → 解説表示 |
| E2E-QUIZ-004 | 不正解回答フロー（テキスト） | クイズ表示 → 誤った選択肢クリック → 「送信」ボタン → 不正解フィードバック表示（赤色） → 解説＋正解表示 |
| E2E-QUIZ-005 | 学習進捗カード表示 | ページ読み込み → 学習進捗カード表示 → 総クイズ数、正答数、正答率が数値で表示される |
| E2E-QUIZ-006 | レベル別進捗表示 | 学習進捗カード → レベル別進捗セクション → N5/N4/N3/N2/N1の進捗バーと正答率が表示される |
| E2E-QUIZ-007 | 進捗グラフ表示フロー | 進捗グラフカード表示 → 期間選択（週/月/年）タブ → グラフ描画 → データポイント表示 |
| E2E-QUIZ-008 | 回答後の進捗更新フロー | 初期進捗を確認 → クイズ回答＋送信 → 進捗カードが自動更新される → 総クイズ数が+1増加 |

---

## テスト詳細仕様

### E2E-QUIZ-001: ページアクセス・初期表示
**前提条件**:
- フロントエンドサーバーが起動している（localhost:3847）
- バックエンドサーバーが起動している（localhost:8534）

**操作手順**:
1. ブラウザで `/quiz` にアクセス
2. ページの読み込み完了を待機

**期待結果**:
- ページタイトル「理解度チェック」が表示される
- クイズカードが表示される
- 学習進捗カードが表示される
- 進捗グラフカードが表示される

**確認要素**:
- `h1` または `h2` に「理解度チェック」が含まれる
- クイズカードのコンテナが存在する
- 進捗カードのコンテナが存在する

---

### E2E-QUIZ-002: ランダムクイズ表示フロー
**前提条件**:
- E2E-QUIZ-001が完了している

**操作手順**:
1. 「ランダムクイズ」または「新しいクイズ」ボタンをクリック
2. API通信の完了を待機
3. クイズ内容の表示を確認

**期待結果**:
- 問題文が表示される
- 3つの選択肢が表示される
- レベル表示（N5/N4/N3/N2/N1）がある
- 問題タイプ（語彙/読解/文法/リスニング）が表示される

**確認要素**:
- 問題文のテキスト要素が存在し、空でない
- 選択肢が3つ存在する
- 各選択肢がクリック可能である

---

### E2E-QUIZ-003: 正解回答フロー（テキスト）
**前提条件**:
- E2E-QUIZ-002が完了している（クイズが表示されている）

**操作手順**:
1. APIレスポンスから正解の選択肢を特定
2. 正解の選択肢をクリック
3. 「回答する」または「送信」ボタンをクリック
4. フィードバック表示を待機

**期待結果**:
- 正解を示すフィードバックが表示される（緑色のメッセージ、チェックマーク等）
- 解説文が表示される
- 「次のクイズへ」ボタンが表示される
- サンプル回答は表示されない（正解時は不要）

**確認要素**:
- フィードバックエリアが表示される
- 正解を示す視覚的要素（色、アイコン）がある
- 解説テキストが存在する

---

### E2E-QUIZ-004: 不正解回答フロー（テキスト）
**前提条件**:
- E2E-QUIZ-002が完了している（クイズが表示されている）

**操作手順**:
1. APIレスポンスから不正解の選択肢を特定
2. 不正解の選択肢をクリック
3. 「回答する」または「送信」ボタンをクリック
4. フィードバック表示を待機

**期待結果**:
- 不正解を示すフィードバックが表示される（赤色のメッセージ、×マーク等）
- 解説文が表示される
- 正解の選択肢（サンプル回答）が表示される
- 「次のクイズへ」ボタンが表示される

**確認要素**:
- フィードバックエリアが表示される
- 不正解を示す視覚的要素（色、アイコン）がある
- 解説テキストが存在する
- サンプル回答が表示される

---

### E2E-QUIZ-005: 学習進捗カード表示
**前提条件**:
- E2E-QUIZ-001が完了している

**操作手順**:
1. ページ読み込み後、学習進捗カードを確認
2. 進捗データの取得を待機

**期待結果**:
- 学習進捗カードが表示される
- 総クイズ数が数値で表示される
- 正解数が数値で表示される
- 正答率がパーセンテージで表示される
- 最終更新日時が表示される

**確認要素**:
- 進捗カードのコンテナが存在する
- 総クイズ数のテキストが数値を含む
- 正答率のテキストが「%」を含む

---

### E2E-QUIZ-006: レベル別進捗表示
**前提条件**:
- E2E-QUIZ-005が完了している

**操作手順**:
1. 学習進捗カード内のレベル別進捗セクションを確認
2. 各レベルの進捗を確認

**期待結果**:
- N5, N4, N3, N2, N1の5つのレベルが表示される
- 各レベルに進捗バーが表示される
- 各レベルに正答率（または完了数/総数）が表示される
- 進捗バーの幅がデータを反映している

**確認要素**:
- 5つのレベル要素が存在する
- 各レベルに進捗バーが存在する
- 進捗データがテキストで表示される

---

### E2E-QUIZ-007: 進捗グラフ表示フロー
**前提条件**:
- E2E-QUIZ-001が完了している

**操作手順**:
1. 進捗グラフカードを確認
2. 期間選択タブ（週/月/年）をクリック
3. グラフの再描画を待機

**期待結果**:
- 進捗グラフカードが表示される
- 期間選択タブ（週/月/年）が表示される
- グラフが描画される（SVGまたはCanvas）
- データポイントが表示される
- タブ切り替え時にグラフが更新される

**確認要素**:
- グラフのコンテナ要素が存在する
- 期間選択タブが3つ存在する
- グラフ要素（SVG/Canvas）が存在する

---

### E2E-QUIZ-008: 回答後の進捗更新フロー
**前提条件**:
- E2E-QUIZ-001が完了している

**操作手順**:
1. 初期の総クイズ数を記録
2. ランダムクイズを取得
3. 任意の選択肢で回答を送信
4. フィードバック表示後、進捗カードを確認

**期待結果**:
- 回答送信後、進捗カードが自動更新される
- 総クイズ数が+1増加する
- 正解した場合、正解数も+1増加する
- 正答率が再計算される
- グラフに新しいデータポイントが追加される

**確認要素**:
- 総クイズ数の値が変化する
- 正答率の値が変化する
- 更新日時が現在時刻に近い値になる

---

## 実行コマンド

```bash
# E2Eテスト実行（クイズページのみ）
npx playwright test tests/e2e/quiz.spec.ts

# デバッグモード
npx playwright test tests/e2e/quiz.spec.ts --debug

# UIモード（インタラクティブ実行）
npx playwright test tests/e2e/quiz.spec.ts --ui
```

---

## 注意事項

### テスト実行前の準備
1. フロントエンドサーバーを起動（localhost:3847）
2. バックエンドサーバーを起動（localhost:8534）
3. データベースにシードデータが投入されている

### テスト設計方針
- **UIフローのみをテスト**: API層のエラーハンドリングは統合テストでカバー済み
- **5-10項目厳守**: 8項目で設計完了
- **実データ使用**: モックではなく実際のAPIを呼び出す
- **統合テスト重複回避**: 認証エラー、バリデーションエラー、404エラーはE2Eに含めない

### テストデータ依存
- 統合テストと同じシードデータを使用
- テスト実行後のクリーンアップは不要（読み取り専用操作が中心）
- 進捗データは各テスト実行時に蓄積される

---

**最終更新**: 2026-01-12
